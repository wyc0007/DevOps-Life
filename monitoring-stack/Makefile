.PHONY: help init up down logs status restart sync-clickhouse  query-clickhouse report-out-html sync-daemon-clickhouse dashboard-grafana sync-grafana reset-grafana test-grafana reset-stack reinstall
.DEFAULT_GOAL := help
# é¡¹ç›®åç§°
APP_NAME := prometheus-clickhouse

# ç¯å¢ƒå˜é‡æ–‡ä»¶
ENV_FILE := .env
ifneq (,$(wildcard $(ENV_FILE)))
ENV_FILE_PRESENT := 1
include $(ENV_FILE)
export
endif

#docker-compose
DOCKER_COMPOSE ?= docker-compose

ifdef ENV_FILE_PRESENT
DC_ENV_FILE := --env-file $(ENV_FILE)
else
DC_ENV_FILE :=
endif

#docker-composeæ—¥å¿—
DC_LOG_SERVICES ?= $(DOCKER_COMPOSE) ps -a
DC_LOG_ARGS ?= -f --tail=200

#å·¥å…·è„šæœ¬ç›®å½•
Tools_DIR := tools
#shç›¸å…³è„šæœ¬
create-working-dashboard-sh := $(Tools_DIR)/sh/create-working-dashboard.sh
fix-grafana-datasource-sh := $(Tools_DIR)/sh/fix-grafana-datasource.sh
reset-grafana-sh := $(Tools_DIR)/sh/reset-grafana.sh
test-grafana-queries-sh := $(Tools_DIR)/sh/test-grafana-queries.sh
#pyç›¸å…³è„šæœ¬
prometheus-to-clickhouse-py := $(Tools_DIR)/py/prometheus-to-clickhouse.py
report-generator-py := $(Tools_DIR)/py/report-generator.py

#é¢œè‰²
GREEN  := \033[0;32m
YELLOW := \033[0;33m
BLUE   := \033[0;34m
NC     := \033[0m

#prometheusé…ç½®
define PROMETHEUS_CONFIG_TEMPLATE
global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'prod'
    service: 'monitoring'

rule_files:
  - /etc/prometheus/alert-rules.yml

alerting:
  alertmanagers:
    - static_configs:
        - targets: []

scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['127.0.0.1:9090']
    scrape_interval: 15s
    metrics_path: '/metrics'
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['127.0.0.1:9100']
    scrape_interval: 15s
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'node-exporter'
      - source_labels: [__scheme__]
        target_label: scheme
        replacement: 'http'
endef
export PROMETHEUS_CONFIG_TEMPLATE

#prometheuså‘Šè­¦è§„åˆ™
define PROMETHEUS_ALERT_RULES_TEMPLATE
groups:
  - name: Node Exporter
    interval: 30s
    rules:
      - alert: HighCPUUsage
        expr: (1 - avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m]))) > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "CPU ä½¿ç”¨ç‡è¿‡é«˜ (instance {{ $$labels.instance }})"
          description: "CPU ä½¿ç”¨ç‡å·²è¾¾åˆ° {{ $$value | humanizePercentage }}"
      - alert: HighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) > 0.85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜ (instance {{ $$labels.instance }})"
          description: "å†…å­˜ä½¿ç”¨ç‡å·²è¾¾åˆ° {{ $$value | humanizePercentage }}"
      - alert: LowDiskSpace
        expr: (node_filesystem_avail_bytes{fstype=~"ext4|xfs"} / node_filesystem_size_bytes) < 0.1
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "ç£ç›˜ç©ºé—´ä¸è¶³ (instance {{ $$labels.instance }})"
          description: "ç£ç›˜å‰©ä½™ç©ºé—´ä¸è¶³ 10%"
endef
export PROMETHEUS_ALERT_RULES_TEMPLATE

#å¸®åŠ©
help:
	@echo "$(BLUE)Prometheus ClickHouse é›†æˆ - Dockerå®¹å™¨è¿è¡Œ$(NC)"
	@echo ""
	@echo "$(GREEN)å¿«é€Ÿå¼€å§‹:$(NC)"
	@echo "  make init      - åˆå§‹åŒ–æœåŠ¡(åˆ›å»ºç›®å½•å’Œé…ç½®æ–‡ä»¶,è®¾ç½®æƒé™)"
	@echo "  make up        - å¯åŠ¨æœåŠ¡"
	@echo "  make status    - æŸ¥çœ‹è¿è¡ŒçŠ¶æ€"
	@echo "  make logs      - æŸ¥çœ‹å®æ—¶æ—¥å¿—"
	@echo "  make restart   - é‡å¯æœåŠ¡"
	@echo "  make down      - åœæ­¢æœåŠ¡"
	@echo ""
	@echo "$(YELLOW)æ•°æ®ç®¡ç†:$(NC)"
	@echo "  make sync-clickhouse            - åŒæ­¥Prometheusæ•°æ®åˆ°ClickHouse"
	@echo "  make query-clickhouse           - æŸ¥è¯¢ClickHouseä¸­çš„æ•°æ®"
	@echo "  make report-out-html            - ç”ŸæˆHTMLç›‘æ§æŠ¥è¡¨"
	@echo "  make sync-daemon-clickhouse     - å¯åŠ¨å®šæ—¶åŒæ­¥å®ˆæŠ¤è¿›ç¨‹-æ¯60ç§’åŒæ­¥ä¸€æ¬¡æ•°æ®"
	@echo ""
	@echo "$(BLUE)æ‰©å±•å‘½ä»¤:$(NC)"
	@echo "  make sync-grafana                 - å°†ClickHouseæ•°æ®æºé…ç½®åˆ°Grafana"
	@echo "  make test-grafana                 - æµ‹è¯•Grafanaæ•°æ®æºé…ç½®"
	@echo "  make dashboard-grafana            - åˆ›å»ºGrafanaä»ªè¡¨æ¿"
	@echo "  make reset-grafana                - é‡ç½®Grafanaæ•°æ®æºä¸ä»ªè¡¨æ¿"
	@echo "  make reset-stack                  - å¸è½½å®¹å™¨å¹¶æ¸…ç†æ•°æ®ç›®å½•"
	@echo "  make reinstall                    - æ¸…ç†åé‡æ–°éƒ¨ç½²æ•´å¥—æœåŠ¡"

#åˆå§‹åŒ–
init:
	@echo "$(YELLOW)æ­£åœ¨åˆå§‹åŒ–Prometheus ClickHouseé›†æˆæœåŠ¡...$(NC)"
	@for dir in clickhouse/clickhouse_data clickhouse/clickhouse_logs clickhouse_reports_html \
		 grafana/data grafana/dashboards grafana/provisioning/datasources grafana/provisioning/dashboards \
		 prometheus/config prometheus/data; do \
		if [ ! -d "$$dir" ]; then mkdir -p "$$dir"; fi; \
	done
	@for dir in grafana/data prometheus/data clickhouse/clickhouse_data clickhouse/clickhouse_logs; do \
		if [ -d "$$dir" ]; then chmod -R 777 "$$dir"; fi; \
	done
	@if [ ! -f prometheus/config/prometheus.yml ]; then \
		printf '%s\n' "$$PROMETHEUS_CONFIG_TEMPLATE" > prometheus/config/prometheus.yml; \
	fi
	@if [ ! -f prometheus/config/alert-rules.yml ]; then \
		printf '%s\n' "$$PROMETHEUS_ALERT_RULES_TEMPLATE" > prometheus/config/alert-rules.yml; \
	fi
	@echo "$(GREEN)âœ“ åˆå§‹åŒ–å®Œæˆ$(NC)"

#å¯åŠ¨
up: init
	@echo "$(YELLOW)æ­£åœ¨å¯åŠ¨Prometheus ClickHouseé›†æˆæœåŠ¡...$(NC)"
	@if ! $(DOCKER_COMPOSE) $(DC_ENV_FILE) up -d; then \
		echo "$(BLUE)âœ— Docker Compose å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—$(NC)"; \
		exit 1; \
	fi
	@echo "$(GREEN)âœ“ æœåŠ¡å¯åŠ¨å®Œæˆ$(NC)"
	@echo "$(YELLOW)ç­‰å¾…æœåŠ¡å¯åŠ¨å®Œæˆ-60ç§’...$(NC)"
	@sleep 60
	@$(MAKE) status

#æ—¥å¿—
logs:
	@echo "$(BLUE)å®æ—¶æ—¥å¿—ç›‘æ§:$(NC)"
	@echo "ğŸ” ç›®æ ‡æœåŠ¡: $(LOG_SERVICES)"
	@echo "ğŸ› ï¸ è¿½åŠ å‚æ•°: $(LOG_ARGS)"
	@$(DOCKER_COMPOSE) $(DC_ENV_FILE) logs $(LOG_ARGS) $(LOG_SERVICES)

#çŠ¶æ€
status:
	@echo "$(BLUE)æœåŠ¡çŠ¶æ€æ£€æŸ¥:$(NC)"
	@$(DOCKER_COMPOSE) $(DC_ENV_FILE) ps -a

#é‡å¯
restart:
	@echo "$(YELLOW)æ­£åœ¨é‡å¯ç›‘æ§æœåŠ¡...$(NC)"
	@$(DOCKER_COMPOSE) $(DC_ENV_FILE) restart
	@echo "$(GREEN)âœ“ æœåŠ¡é‡å¯å®Œæˆ$(NC)"

#åœæ­¢
down:
	@echo "$(YELLOW)æ­£åœ¨åœæ­¢Prometheus ClickHouseé›†æˆæœåŠ¡...$(NC)"
	@$(DOCKER_COMPOSE) $(DC_ENV_FILE) down -v
	@echo "$(GREEN)âœ“ æœåŠ¡å·²åœæ­¢$(NC)"

#åŒæ­¥
sync-clickhouse:
	@echo "$(BLUE)åŒæ­¥Prometheusæ•°æ®åˆ°ClickHouse...$(NC)"
	@python3 $(prometheus-to-clickhouse-py)

daemon-clickhouse:
	@echo "$(BLUE)å¯åŠ¨å®šæ—¶åŒæ­¥å®ˆæŠ¤è¿›ç¨‹...$(NC)"
	@echo "$(YELLOW)æŒ‰ Ctrl+C åœæ­¢å®ˆæŠ¤è¿›ç¨‹$(NC)"
	@echo "â° æ¯60ç§’åŒæ­¥ä¸€æ¬¡æ•°æ®..."
	@while true; do \
		echo "$(shell date '+%Y-%m-%d %H:%M:%S') - å¼€å§‹æ•°æ®åŒæ­¥..."; \
		python3 $(prometheus-to-clickhouse-py) > /dev/null 2>&1; \
		if [ $$? -eq 0 ]; then \
			echo "$(shell date '+%Y-%m-%d %H:%M:%S') - æ•°æ®åŒæ­¥å®Œæˆ"; \
		else \
			echo "$(shell date '+%Y-%m-%d %H:%M:%S') - æ•°æ®åŒæ­¥å¤±è´¥"; \
		fi; \
		sleep 60; \
	done


#æŸ¥è¯¢
query-clickhouse:
	@echo "$(BLUE)æŸ¥è¯¢ClickHouseä¸­çš„Prometheusæ•°æ®:$(NC)"
	@echo "æ€»è®°å½•æ•°:"
	@docker exec clickhouse-server clickhouse-client --user $${CLICKHOUSE_USER:-default} --password $${CLICKHOUSE_PASSWORD:?æœªè®¾ç½®CLICKHOUSE_PASSWORD} --query "SELECT count() FROM $${CLICKHOUSE_DB:-prometheus}.prometheus_metrics"
	@echo ""
	@echo "æœ€æ–°10æ¡è®°å½•:"
	@docker exec clickhouse-server clickhouse-client --user $${CLICKHOUSE_USER:-default} --password $${CLICKHOUSE_PASSWORD:?æœªè®¾ç½®CLICKHOUSE_PASSWORD} --query "SELECT metric_name, value, job, formatDateTime(timestamp, '%Y-%m-%d %H:%M:%S') as time FROM $${CLICKHOUSE_DB:-prometheus}.prometheus_metrics ORDER BY timestamp DESC LIMIT 10"

#æŠ¥è¡¨
report-out-html:
	@echo "$(BLUE)ç”ŸæˆHTMLç›‘æ§æŠ¥è¡¨...$(NC)"
	@python3 $(report-generator-py)

#ä»ªè¡¨æ¿
dashboard-grafana:
	@echo "$(BLUE)åˆ›å»ºå¯å·¥ä½œçš„Grafanaä»ªè¡¨æ¿...$(NC)"
	@./$(create-working-dashboard-sh)
	@echo "$(BLUE)Grafanaå¯è§†åŒ–ä»ªè¡¨æ¿:$(NC)"
	@echo "ğŸŒ è®¿é—®åœ°å€: $(YELLOW)$${GRAFANA_URL:-http://localhost:3000}$(NC)"
	@echo "ğŸ‘¤ ç”¨æˆ·å: $(GREEN)$${GRAFANA_USER:-admin}$(NC)"
	@echo "ğŸ”‘ å¯†ç : $(GREEN)$${GF_SECURITY_ADMIN_PASSWORD:?æœªè®¾ç½®GF_SECURITY_ADMIN_PASSWORD}$(NC)"
	@echo "ğŸ’¡ æç¤º: å¦‚æœæ˜¾ç¤º'No data'ï¼Œè¯·è¿è¡Œ make sync-grafana"
	@echo "ğŸ“„ .env æ–‡ä»¶ä½äº $(ENV_FILE)ï¼Œè¯·ç¡®ä¿å·²æ­£ç¡®å¡«å†™å¯†ç "

#æµ‹è¯•Grafanaæ•°æ®æºé…ç½®
test-grafana:
	@echo "$(BLUE)æµ‹è¯•Grafanaæ•°æ®æºé…ç½®...$(NC)"	
	@GRAFANA_URL="$${GRAFANA_URL:-http://localhost:3000}" GRAFANA_USER="$${GRAFANA_USER:-admin}" GRAFANA_PASS="$${GF_SECURITY_ADMIN_PASSWORD:?æœªè®¾ç½®GF_SECURITY_ADMIN_PASSWORD}" CLICKHOUSE_URL="$${CLICKHOUSE_URL:-http://localhost:8123}" CLICKHOUSE_HOST="$${CLICKHOUSE_HOST:-localhost}" CLICKHOUSE_PORT="$${CLICKHOUSE_PORT:-8123}" CLICKHOUSE_DB="$${CLICKHOUSE_DB:-prometheus}" CLICKHOUSE_USER="$${CLICKHOUSE_USER:-default}" CLICKHOUSE_PASSWORD="$${CLICKHOUSE_PASSWORD:?æœªè®¾ç½®CLICKHOUSE_PASSWORD}" $(test-grafana-queries-sh)

#å°†ClickHouseæ•°æ®æºé…ç½®åˆ°Grafana
sync-grafana:
	@echo "$(BLUE)å°†ClickHouseæ•°æ®æºé…ç½®åˆ°Grafana...$(NC)"	
	@GRAFANA_URL="$${GRAFANA_URL:-http://localhost:3000}" GRAFANA_USER="$${GRAFANA_USER:-admin}" GRAFANA_PASS="$${GF_SECURITY_ADMIN_PASSWORD:?æœªè®¾ç½®GF_SECURITY_ADMIN_PASSWORD}" CLICKHOUSE_URL="$${CLICKHOUSE_URL:-http://localhost:8123}" CLICKHOUSE_HOST="$${CLICKHOUSE_HOST:-localhost}" CLICKHOUSE_PORT="$${CLICKHOUSE_PORT:-8123}" CLICKHOUSE_DB="$${CLICKHOUSE_DB:-prometheus}" CLICKHOUSE_USER="$${CLICKHOUSE_USER:-default}" CLICKHOUSE_PASSWORD="$${CLICKHOUSE_PASSWORD:?æœªè®¾ç½®CLICKHOUSE_PASSWORD}" $(fix-grafana-datasource-sh)


#é‡ç½®
reset-grafana:
	@echo "$(BLUE)é‡ç½®Grafanaæ•°æ®æºä¸ä»ªè¡¨æ¿...$(NC)"
	@GRAFANA_URL="$${GRAFANA_URL:-http://localhost:3000}" GRAFANA_USER="$${GRAFANA_USER:-admin}" GRAFANA_PASS="$${GF_SECURITY_ADMIN_PASSWORD:?æœªè®¾ç½®GF_SECURITY_ADMIN_PASSWORD}" CLICKHOUSE_URL="$${CLICKHOUSE_URL:-http://localhost:8123}" CLICKHOUSE_HOST="$${CLICKHOUSE_HOST:-localhost}" CLICKHOUSE_PORT="$${CLICKHOUSE_PORT:-8123}" CLICKHOUSE_DB="$${CLICKHOUSE_DB:-prometheus}" CLICKHOUSE_USER="$${CLICKHOUSE_USER:-default}" CLICKHOUSE_PASSWORD="$${CLICKHOUSE_PASSWORD:?æœªè®¾ç½®CLICKHOUSE_PASSWORD}" $(reset-grafana-sh)

#å¸è½½
reset-stack:
	@echo "$(BLUE)åœæ­¢å¹¶æ¸…ç†ç›‘æ§æ ˆ...$(NC)"
	@$(DOCKER_COMPOSE) $(DC_ENV_FILE) down -v || true
	@for dir in grafana/data grafana/dashboards grafana/provisioning/datasources grafana/provisioning/dashboards \
		prometheus/data clickhouse/clickhouse_data clickhouse/clickhouse_logs clickhouse_reports_html; do \
		if [ -d "$$dir" ]; then \
			echo "  - ç§»é™¤ $$dir"; \
			rm -rf "$$dir"; \
		fi; \
	done
	@$(MAKE) init

reinstall: reset-stack up